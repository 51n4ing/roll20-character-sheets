<!-- Spell descriptions reproduced from the Dragonslayer™️ Role-Playing Game
     under the Dragonslayer™️ Role-Playing Game Third-Party License.
     This character sheet is not affiliated with Old School
     Publishing. Dragonslayer™️ RPG © 2024. -->
<template class="ds-character-sheet">
  <div class="ds-tabs">
    <input type="checkbox" id="character_tab_control" name="attr_show_character" class="ds-tab-content-control" checked>
    <button type="action" class="ds-tab-button" name="act_character_tab">Character</button>
    <input type="checkbox" id="notes_tab_control" name="attr_show_notes" class="ds-tab-content-control">
    <button type="action" class="ds-tab-button" name="act_notes_tab">Notes</button>
    <input type="checkbox" id="spells_tab_control" name="attr_show_spells" class="ds-tab-content-control">
    <button type="action" class="ds-tab-button" name="act_spells_tab">Spells</button>
  </div>

  <!-- Hidden checkboxes for content control -->
  <input type="checkbox" id="character_content" name="attr_show_character" class="ds-tab-content-control" checked>
  <div id="character" class="ds-tab-content">
    <!-- Existing character sheet content -->
    <div class="ds-sheet-container">
      <div class="ds-sheet-header">
        <!-- CHARACTER DETAILS -->
        <div class="ds-character-info">
          <div class="ds-info-row">
            <div class="ds-full-width">
              <label>Character Name</label>
              <input type="text" name="attr_character_name" />
            </div>
            <div class="ds-col-small">
              <label>Race</label>
              <select name="attr_race" class="ds-select">
                <option value="Human">Human</option>
                <option value="Cyclopsman">Cyclopsman</option>
                <option value="Dwarf">Dwarf</option>
                <option value="Elf">Elf</option>
                <option value="Gnome">Gnome</option>
                <option value="Halfling">Halfling</option>
                <option value="Half-Elf">Half-Elf</option>
                <option value="Half-Orc">Half-Orc</option>
              </select>
            </div>
            <div class="ds-col-small">
              <label>Class</label>
              <select name="attr_class" class="ds-select">
                <option value="Cleric">Cleric</option>
                <option value="Druid">Druid</option>
                <option value="Monk">Monk</option>
                <option value="Fighter">Fighter</option>
                <option value="Barbarian">Barbarian</option>
                <option value="Paladin">Paladin</option>
                <option value="Ranger">Ranger</option>
                <option value="Magic-User">Magic-User</option>
                <option value="Illusionist">Illusionist</option>
                <option value="Thief">Thief</option>
                <option value="Assassin">Assassin</option>
              </select>
            </div>
            <div class="ds-col-tiny">
              <label>Level</label>
              <input type="number" name="attr_level" />
            </div>
            <div class="ds-col-large">
              <label>Title</label>
              <input type="text" name="attr_title" class="ds-title-input" />
            </div>
          </div>

          <div class="ds-info-row">
            <div class="ds-col-medium">
              <label>Alignment</label>
              <input type="text" name="attr_alignment" />
            </div>
            <div class="ds-col-medium">
              <label>Deity</label>
              <input type="text" name="attr_deity" />
            </div>
            <div class="ds-col-tiny">
              <label>Age</label>
              <input type="number" name="attr_age" />
            </div>
            <div class="ds-col-small">
              <label>Height</label>
              <input type="text" name="attr_height" />
            </div>
            <div class="ds-col-small">
              <label>Weight</label>
              <input type="text" name="attr_weight" />
            </div>
            <div class="ds-full-width">
              <label>Languages</label>
              <input type="text" name="attr_languages" />
            </div>
          </div>

          <div class="ds-info-row">
            <div class="ds-col-tiny">
              <label>XP Bonus %</label>
              <input type="number" name="attr_xp_bonus" />
            </div>
            <div class="ds-col-tiny">
              <label>Experience</label>
              <input type="number" name="attr_experience" />
            </div>
            <div class="ds-col-tiny">
              <label>Move</label>
              <input type="number" name="attr_move" />
            </div>
            <div class="ds-col-tiny">
              <label>Attack Bonus</label>
              <input type="number" name="attr_attack_bonus" />
            </div>
          </div>
        </div>
      </div>

      <!-- MIDDLE SECTION: AC/HP/MOVE & WEAPON -->
      <div class="ds-middle-section">
        <!-- LEFT SIDE: AC, HP, and Movement in a vertical layout -->
        <div class="ds-defense-container">
          <!-- AC Section -->
          <div class="ds-section-label">ARMOR CLASS</div>
          <input type="number" name="attr_armor_class" class="ds-input" />

          <div class="ds-section-label">Armor Description</div>
          <input type="text" name="attr_armor_description" class="ds-input" />

          <!-- HP Section -->
          <div class="ds-section-label">HIT POINTS</div>
          <div class="ds-hp-row">
            <div class="ds-hp-item">
              <label>Current:</label>
              <input type="number" name="attr_hp" class="ds-input" />
            </div>
            <div class="ds-hp-item">
              <label>Max:</label>
              <input type="number" name="attr_hp_max" class="ds-input" />
            </div>
            <div class="ds-hp-item ds-hit-die-container">
              <label>Hit die:</label>
              <input type="text" name="attr_hit_die" id="ds-hit-die" />
              <button type="roll"
                value="&{template:default} {{name=@{character_name} Rolled a Hit Die}} {{Hit Points=[[@{hit_die}]]}}"></button>
            </div>
          </div>
        </div>

        <!-- RIGHT SIDE: WEAPON CONTAINER -->
        <div class="ds-weapon-container">
          <!-- Column headers -->
          <div class="ds-weapon-header">
            <div class="ds-weapon-name-header">Weapon</div>
            <div class="ds-weapon-damage-header">Damage</div>
          </div>

          <div class="ds-weapon-item">
            <label>Primary</label>
            <div class="ds-weapon-row">
              <input type="text" name="attr_weapon_name" class="ds-weapon-name" />
              <input type="text" name="attr_weapon_primary_dmg" class="ds-dmg-field" />
              <button type="roll" class="ds-weapon-roll"
                value="&{template:ds-attack} {{color=black}} {{title=@{weapon_name} Attack}} {{subtitle=@{character_name}}} {{ac_hit=[[20 - @{str_melee_mod} - @{attack_bonus} - (?{Situational Bonus?|0}) - 1d20]]}} {{damage=[[@{weapon_primary_dmg}]]}} {{crit_dmg=[[2*(@{weapon_primary_dmg})]]}} {{crit=Damage doubled!}} {{fumble=Roll on the critical miss table!}}" />
            </div>
          </div>

          <div class="ds-weapon-item">
            <label>Secondary</label>
            <div class="ds-weapon-row">
              <input type="text" name="attr_weapon_secondary_name" class="ds-weapon-name" />
              <input type="text" name="attr_weapon_secondary_dmg" class="ds-dmg-field" />
              <button type="roll" class="ds-weapon-roll"
                value="&{template:ds-attack} {{color=black}} {{title=@{weapon_secondary_name} Attack}} {{subtitle=@{character_name}}} {{ac_hit=[[20 - @{str_melee_mod} - @{attack_bonus} - (?{Situational Bonus?|0}) - 1d20]]}} {{damage=[[@{weapon_secondary_dmg}]]}} {{crit_dmg=[[2*(@{weapon_secondary_dmg})]]}} {{crit=Damage doubled!}} {{fumble=Roll on the critical miss table!}}" />
            </div>
          </div>

          <div class="ds-weapon-item">
            <label>Missile Weapon</label>
            <div class="ds-weapon-row">
              <input type="text" name="attr_missile_weapon" class="ds-weapon-name" />
              <input type="text" name="attr_missile_dmg" class="ds-dmg-field" />
              <input type="hidden" name="attr_missile_race_mod" value="0" />
              <button type="roll" class="ds-weapon-roll"
                value="&{template:ds-attack} {{color=black}} {{title=@{missile_weapon} Attack}} {{subtitle=@{character_name}}} {{ac_hit=[[20 - @{dex_missile} - @{attack_bonus} - @{missile_race_mod} - (?{Situational Bonus?|0}) - 1d20]]}} {{damage=[[@{missile_dmg}]]}} {{crit_dmg=[[2*(@{missile_dmg})]]}} {{crit=Damage doubled!}} {{fumble=Roll on the critical miss table!}}" />
            </div>

            <!-- Ammo tracking -->
            <div class="ds-ammo-tracking">
              <label class="ds-ammo-label">Ammo:</label>
              <div class="ds-ammo-checkboxes">
                <input type="checkbox" name="attr_ammo_1" class="ds-ammo-box" />
                <input type="checkbox" name="attr_ammo_2" class="ds-ammo-box" />
                <input type="checkbox" name="attr_ammo_3" class="ds-ammo-box" />
                <input type="checkbox" name="attr_ammo_4" class="ds-ammo-box" />
                <input type="checkbox" name="attr_ammo_5" class="ds-ammo-box" />
                <input type="checkbox" name="attr_ammo_6" class="ds-ammo-box" />
                <input type="checkbox" name="attr_ammo_7" class="ds-ammo-box" />
                <input type="checkbox" name="attr_ammo_8" class="ds-ammo-box" />
                <input type="checkbox" name="attr_ammo_9" class="ds-ammo-box" />
                <input type="checkbox" name="attr_ammo_10" class="ds-ammo-box" />
                <input type="checkbox" name="attr_ammo_11" class="ds-ammo-box" />
                <input type="checkbox" name="attr_ammo_12" class="ds-ammo-box" />
                <input type="checkbox" name="attr_ammo_13" class="ds-ammo-box" />
                <input type="checkbox" name="attr_ammo_14" class="ds-ammo-box" />
                <input type="checkbox" name="attr_ammo_15" class="ds-ammo-box" />
                <input type="checkbox" name="attr_ammo_16" class="ds-ammo-box" />
                <input type="checkbox" name="attr_ammo_17" class="ds-ammo-box" />
                <input type="checkbox" name="attr_ammo_18" class="ds-ammo-box" />
                <input type="checkbox" name="attr_ammo_19" class="ds-ammo-box" />
                <input type="checkbox" name="attr_ammo_20" class="ds-ammo-box" />
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ULTRA COMPACT ABILITIES AND SAVES SECTION -->
      <div class="ds-abilities-container">
        <!-- Left column: Abilities -->
        <div class="ds-abilities-panel">
          <div class="ds-section-header">ABILITIES</div>

          <!-- Roll Template for Ability Checks -->
          <rolltemplate class="sheet-rolltemplate-ds-check">
            <div class="sheet-template-container">
              <div class="sheet-template-head {{color}}">
                <div class="sheet-template-head-row">
                  {{#title}}
                  <div class="sheet-template-head-cell-left">{{title}}</div>
                  {{/title}}
                  {{^title}}
                  <div class="sheet-template-head-cell-left">{{checkvs}}</div>
                  {{/title}}
                  {{#subtitle}}
                  <div class="sheet-template-head-cell-right">{{subtitle}}</div>
                  {{/subtitle}}
                  {{^subtitle}}
                  {{#character}}
                  <div class="sheet-template-head-cell-right">for {{character}}</div>
                  {{/character}}
                  {{/subtitle}}
                </div>
              </div>
              <div class="sheet-template-body">
                <div class="sheet-template-body-row">
                  <span class="sheet-check-label">Roll</span>
                  <span class="sheet-check-label"></span>
                  <span class="sheet-check-label">Target</span>
                </div>
                <div class="sheet-template-body-row">
                  <span class="sheet-check-value">{{checkroll}}</span>
                  <span class="sheet-check-value">&le;</span>
                  <span class="sheet-check-value">{{checktarget}}</span>
                </div>
                {{#rollTotal() checkroll checktarget}}
                {{#rollWasCrit() checkroll}}

                {{#crit}}
                <div class="sheet-template-result sheet-template-success">
                  CRITICAL SUCCESS!
                  {{#crit}}
                  <br>
                  <span class="sheet-template-result-description">{{crit}}</span>
                  {{/crit}}
                </div>
                {{/crit}}
                {{^crit}}
                <div class="sheet-template-result sheet-template-success">
                  Success!
                  {{#success}}
                  <br>
                  <span class="sheet-template-result-description">{{success}}</span>
                  {{/success}}
                </div>
                {{/crit}}
                {{/rollWasCrit() checkroll}}

                {{#rollWasFumble() checkroll}}
                {{#fumble}}
                <div class="sheet-template-result sheet-template-failure">
                  CRITICAL FAILURE!
                  {{#fumble}}
                  <br>
                  <span class="sheet-template-result-description">{{fumble}}</span>
                  {{/fumble}}
                </div>
                {{/fumble}}
                {{^fumble}}
                <div class="sheet-template-result sheet-template-success">
                  Success!
                  {{#success}}
                  <br>
                  <span class="sheet-template-result-description">{{success}}</span>
                  {{/success}}
                </div>
                {{/fumble}}
                {{/rollWasFumble() checkroll}}

                {{#^rollWasCrit() checkroll}}
                {{#^rollWasFumble() checkroll}}
                <div class="sheet-template-result sheet-template-success">
                  Success!
                  {{#success}}
                  <br>
                  <span class="sheet-template-result-description">{{success}}</span>
                  {{/success}}
                </div>
                {{/^rollWasFumble() checkroll}}
                {{/^rollWasCrit() checkroll}}
                {{/rollTotal() checkroll checktarget}}

                {{#rollLess() checkroll checktarget}}
                {{#rollWasCrit() checkroll}}
                {{#crit}}
                <div class="sheet-template-result sheet-template-success">
                  CRITICAL SUCCESS!
                  {{#crit}}
                  <br>
                  <span class="sheet-template-result-description">{{crit}}</span>
                  {{/crit}}
                </div>
                {{/crit}}
                {{^crit}}
                <div class="sheet-template-result sheet-template-success">
                  Success!
                  {{#success}}
                  <br>
                  <span class="sheet-template-result-description">{{success}}</span>
                  {{/success}}
                </div>
                {{/crit}}
                {{/rollWasCrit() checkroll}}

                {{#rollWasFumble() checkroll}}
                {{#fumble}}
                <div class="sheet-template-result sheet-template-failure">
                  CRITICAL FAILURE!
                  {{#fumble}}
                  <br>
                  <span class="sheet-template-result-description">{{fumble}}</span>
                  {{/fumble}}
                </div>
                {{/fumble}}
                {{^fumble}}
                <div class="sheet-template-result sheet-template-success">
                  Success!
                  {{#success}}
                  <br>
                  <span class="sheet-template-result-description">{{success}}</span>
                  {{/success}}
                </div>
                {{/fumble}}
                {{/rollWasFumble() checkroll}}

                {{#^rollWasCrit() checkroll}}
                {{#^rollWasFumble() checkroll}}
                <div class="sheet-template-result sheet-template-success">
                  Success!
                  {{#success}}
                  <br>
                  <span class="sheet-template-result-description">{{success}}</span>
                  {{/success}}
                </div>
                {{/^rollWasFumble() checkroll}}
                {{/^rollWasCrit() checkroll}}
                {{/rollLess() checkroll checktarget}}

                {{#rollGreater() checkroll checktarget}}
                {{#rollWasFumble() checkroll}}
                {{#fumble}}
                <div class="sheet-template-result sheet-template-failure">
                  CRITICAL FAILURE!
                  {{#fumble}}
                  <br>
                  <span class="sheet-template-result-description">{{fumble}}</span>
                  {{/fumble}}
                </div>
                {{/fumble}}
                {{^fumble}}
                <div class="sheet-template-result sheet-template-failure">
                  Failed!
                  {{#fail}}
                  <br>
                  <span class="sheet-template-result-description">{{fail}}</span>
                  {{/fail}}
                </div>
                {{/fumble}}
                {{/rollWasFumble() checkroll}}

                {{#^rollWasFumble() checkroll}}
                <div class="sheet-template-result sheet-template-failure">
                  Failed!
                  {{#fail}}
                  <br>
                  <span class="sheet-template-result-description">{{fail}}</span>
                  {{/fail}}
                </div>
                {{/^rollWasFumble() checkroll}}
                {{/rollGreater() checkroll checktarget}}
              </div>
            </div>
          </rolltemplate>

          <table class="ds-abilities-table">
            <!-- Strength -->
            <tr class="ds-ability-row">
              <td class="ds-ability-name">STR</td>
              <td class="ds-ability-score-cell">
                <input type="number" name="attr_strength" class="ds-ability-score" />
                <button type="roll"
                  value="&{template:ds-check} {{title=Strength Check}} {{subtitle=for @{character_name}}} {{checkroll=[[1d20cs1cf20-(?{Misc Modifier?|0})]]}} {{checktarget=[[ @{strength} ]]}} {{success=A great feat of strength!}} {{fail=Not strong enough!}}"
                  title="Roll STR Check (d20 ≤ STR)"></button>
              </td>
              <td class="ds-mods-cell">
                <div class="ds-mod-item">
                  <label>Melee</label>
                  <input type="text" name="attr_str_melee_mod" />
                </div>
                <div class="ds-mod-item">
                  <label>Force Door</label>
                  <input type="text" name="attr_str_force_door" />
                </div>
              </td>
            </tr>

            <!-- Intelligence -->
            <tr class="ds-ability-row">
              <td class="ds-ability-name">INT</td>
              <td class="ds-ability-score-cell">
                <input type="number" name="attr_intelligence" class="ds-ability-score" />
                <button type="roll"
                  value="&{template:ds-check} {{title=Intelligence Check}} {{subtitle=for @{character_name}}} {{checkroll=[[1d20cs1cf20-(?{Misc Modifier?|0})]]}} {{checktarget=[[ @{intelligence} ]]}} {{success=Your mind is sharp!}} {{fail=Not smart enough!}}"
                  title="Roll INT Check (d20 ≤ INT)"></button>
              </td>
              <td class="ds-mods-cell">
                <div class="ds-mod-item">
                  <label>Languages</label>
                  <input type="text" name="attr_int_languages" />
                </div>
              </td>
            </tr>

            <!-- Wisdom -->
            <tr class="ds-ability-row">
              <td class="ds-ability-name">WIS</td>
              <td class="ds-ability-score-cell">
                <input type="number" name="attr_wisdom" class="ds-ability-score" />
                <button type="roll"
                  value="&{template:ds-check} {{title=Wisdom Check}} {{subtitle=for @{character_name}}} {{checkroll=[[1d20cs1cf20-(?{Misc Modifier?|0})]]}} {{checktarget=[[ @{wisdom} ]]}} {{success=You see the truth!}} {{fail=Not wise enough!}}"
                  title="Roll WIS Check (d20 ≤ WIS)"></button>
              </td>
              <td class="ds-mods-cell">
                <div class="ds-mod-item">
                  <label>Magic Save</label>
                  <input type="text" name="attr_wis_magic_save" />
                </div>
              </td>
            </tr>

            <!-- Dexterity -->
            <tr class="ds-ability-row">
              <td class="ds-ability-name">DEX</td>
              <td class="ds-ability-score-cell">
                <input type="number" name="attr_dexterity" class="ds-ability-score" />
                <button type="roll"
                  value="&{template:ds-check} {{title=Dexterity Check}} {{subtitle=for @{character_name}}} {{checkroll=[[1d20cs1cf20-(?{Misc Modifier?|0})]]}} {{checktarget=[[ @{dexterity} ]]}} {{success=You move with grace!}} {{fail=Not fast enough!}}"
                  title="Roll DEX Check (d20 ≤ DEX)"></button>
              </td>
              <td class="ds-mods-cell">
                <div class="ds-mod-item">
                  <label>Missile</label>
                  <input type="text" name="attr_dex_missile" />
                </div>
                <div class="ds-mod-item">
                  <label>Armor</label>
                  <input type="text" name="attr_dex_armor" />
                </div>
              </td>
            </tr>

            <!-- Constitution -->
            <tr class="ds-ability-row">
              <td class="ds-ability-name">CON</td>
              <td class="ds-ability-score-cell">
                <input type="number" name="attr_constitution" class="ds-ability-score" />
                <button type="roll"
                  value="&{template:ds-check} {{title=Constitution Check}} {{subtitle=for @{character_name}}} {{checkroll=[[1d20cs1cf20-(?{Misc Modifier?|0})]]}} {{checktarget=[[ @{constitution} ]]}} {{success=You endure with fortitude!}} {{fail=Not tough enough!}}"
                  title="Roll CON Check (d20 ≤ CON)"></button>
              </td>
              <td class="ds-mods-cell">
                <div class="ds-mod-item">
                  <label>Hit Point</label>
                  <input type="text" name="attr_con_hp" />
                </div>
              </td>
            </tr>

            <!-- Charisma -->
            <tr class="ds-ability-row">
              <td class="ds-ability-name">CHA</td>
              <td class="ds-ability-score-cell">
                <input type="number" name="attr_charisma" class="ds-ability-score" />
                <button type="roll"
                  value="&{template:ds-check} {{title=Charisma Check}} {{subtitle=for @{character_name}}} {{checkroll=[[1d20cs1cf20-(?{Misc Modifier?|0})]]}} {{checktarget=[[ @{charisma} ]]}} {{success=Quite charming!}} {{fail=Not charming enough!}}"
                  title="Roll CHA Check (d20 ≤ CHA)"></button>
              </td>
              <td class="ds-mods-cell">
                <div class="ds-mod-item">
                  <label>Henchmen</label>
                  <input type="text" name="attr_cha_henchmen" />
                </div>
                <div class="ds-mod-item">
                  <label>Morale</label>
                  <input type="text" name="attr_cha_morale" />
                </div>
              </td>
            </tr>
          </table>
        </div>

        <!-- Right column: Saving Throws -->
        <div class="ds-saves-panel">
          <div class="ds-section-header">SAVING THROWS</div>

          <div class="ds-saves-container">
            <div class="ds-save-item">
              <label>Breath</label>
              <input type="number" name="attr_save_breath" />
              <input type="hidden" name="attr_save_breath_race_bonus" value="0" />
              <button type="roll" name="roll_save_breath"
                value="&{template:ds-save} {{title=Save vs. Breath}} {{subtitle=for @{character_name}}} {{savetarget=[[ @{save_breath} ]]}} {{saveroll=[[1d20+(?{Misc. Modifier?|0})]]}} {{success=You made your check}} {{fail=You missed your check}} {{fumble=You missed your check against all odds}}"></button>
            </div>
            <div class="ds-save-item">
              <label>Death</label>
              <input type="number" name="attr_save_death" />
              <input type="hidden" name="attr_save_death_race_bonus" value="0" />
              <button type="roll" name="roll_save_death"
                value="&{template:ds-save} {{title=Save vs. Death}} {{subtitle=for @{character_name}}} {{savetarget=[[ @{save_death} ]]}} {{saveroll=[[1d20+(?{Misc. Modifier?|0})]]}} {{success=You made your check}} {{fail=You missed your check}} {{fumble=You missed your check against all odds}}"></button>
            </div>
            <div class="ds-save-item">
              <label>Stone</label>
              <input type="number" name="attr_save_stone" />
              <input type="hidden" name="attr_save_stone_race_bonus" value="0" />
              <button type="roll" name="roll_save_stone"
                value="&{template:ds-save} {{title=Save vs. Stone}} {{subtitle=for @{character_name}}} {{savetarget=[[ @{save_stone} ]]}} {{saveroll=[[1d20+(?{Misc. Modifier?|0})]]}} {{success=You made your check}} {{fail=You missed your check}} {{fumble=You missed your check against all odds}}"></button>
            </div>
            <div class="ds-save-item">
              <label>Wand</label>
              <input type="number" name="attr_save_wand" />
              <input type="hidden" name="attr_save_wand_race_bonus" value="0" />
              <button type="roll" name="roll_save_wand"
                value="&{template:ds-save} {{title=Save vs. Wand}} {{subtitle=for @{character_name}}} {{savetarget=[[ @{save_wand} ]]}} {{saveroll=[[1d20+(?{Misc. Modifier?|0})]]}} {{success=You made your check}} {{fail=You missed your check}} {{fumble=You missed your check against all odds}}"></button>
            </div>
            <div class="ds-save-item">
              <label>Spell</label>
              <input type="number" name="attr_save_spell" />
              <input type="hidden" name="attr_save_spell_race_bonus" value="0" />
              <button type="roll" name="roll_save_spell"
                value="&{template:ds-save} {{title=Save vs. Spell}} {{subtitle=for @{character_name}}} {{savetarget=[[ @{save_spell} ]]}} {{saveroll=[[1d20+(?{Misc. Modifier?|0})]]}} {{success=You made your check}} {{fail=You missed your check}} {{fumble=You missed your check against all odds}}"></button>
            </div>
          </div>
        </div>
      </div>

      <!-- LOWER SECTIONS -->
      <div class="ds-lower-section">
        <div class="ds-two-columns">
          <!-- EQUIPMENT & ITEMS -->
          <div class="ds-equipment-section">
            <h3>EQUIPMENT & ITEMS</h3>
            <div class="ds-equipment-header">
              <div class="ds-count-header">Count</div>
              <div class="ds-description-header">Description</div>
              <div class="ds-weight-header">Weight</div>
            </div>
            <fieldset class="repeating_equipment">
              <input type="number" name="attr_item_count" class="ds-item-count" />
              <input type="text" name="attr_item_description" class="ds-item-description" />
              <input type="number" name="attr_item_weight" class="ds-item-weight" />
            </fieldset>

            <!-- WEALTH & TREASURE -->
            <div class="ds-treasure-box">
              <h4>WEALTH & TREASURE</h4>
              <div class="ds-currency-row">
                <label>cp</label>
                <input type="number" name="attr_cp" />
              </div>
              <div class="ds-currency-row">
                <label>sp</label>
                <input type="number" name="attr_sp" />
              </div>
              <div class="ds-currency-row">
                <label>ep</label>
                <input type="number" name="attr_ep" />
              </div>
              <div class="ds-currency-row">
                <label>gp</label>
                <input type="number" name="attr_gp" />
              </div>
              <div class="ds-currency-row">
                <label>pp</label>
                <input type="number" name="attr_pp" />
              </div>

              <!-- Additional Treasure -->
              <div class="ds-additional-treasure">
                <fieldset class="repeating_treasure">
                  <input type="text" name="attr_treasure_type" class="ds-treasure-type" placeholder="Treasure Type" />
                  <input type="number" name="attr_treasure_amount" class="ds-treasure-amount" placeholder="Amount" />
                </fieldset>
              </div>
            </div>
          </div>

          <!-- OTHER ABILITIES -->
          <div class="ds-abilities-spells-section">
            <h3>OTHER ABILITIES</h3>
            <input type="checkbox" name="attr_show_turn_undead" class="ds-show-turn-undead" style="display: none;" />
            <div class="ds-turn-undead-section">
              <div class="ds-ability-entry">
                <div class="ds-ability-roll-group">
                  <button type="action" name="act_turn_undead" class="ds-turn-undead-button">Turn Undead</button>
                  <input type="number" name="attr_turn_undead_charges" value="3" min="0" max="3"
                    class="ds-turn-undead-charges" />
                </div>
              </div>
            </div>
            <div class="ds-abilities-list">
              <fieldset class="repeating_abilities">
                <div class="ds-ability-entry">
                  <div class="ds-ability-roll-group">
                    <input type="text" name="attr_ability_name" class="ds-ability-name-input"
                      placeholder="Ability Name" />
                    <input type="text" name="attr_ability_dice" class="ds-ability-dice" placeholder="1d20" />
                    <select name="attr_ability_compare" class="ds-ability-compare">
                      <option value="le">&le;</option>
                      <option value="ge">&ge;</option>
                    </select>
                    <input type="number" name="attr_ability_target" class="ds-ability-target" placeholder="Target" />
                    <button type="roll" name="roll_custom_ability"
                      value="&{template:ds-check} {{title=@{ability_name}}} {{subtitle=for @{character_name}}} {{checkroll=[[@{ability_dice}-(?{Misc Modifier?|0})]]}} {{checktarget=[[@{ability_target}]]}} {{success=Success!}} {{fail=Failed!}}"></button>
                  </div>
                </div>
              </fieldset>
            </div>

            <!-- MISC. FEATURES -->
            <div class="ds-misc-features-box">
              <h4>MISC. FEATURES</h4>
              <fieldset class="repeating_features">
                <input type="text" name="attr_feature_desc" class="ds-feature-desc" placeholder="Feature Description" />
              </fieldset>
            </div>

            <!-- SPELLS PER DAY -->
            <input type="checkbox" name="attr_show_spells" class="ds-show-spells" />
            <div class="ds-spells-per-day-box">
              <h4>SPELLS PER DAY</h4>
              <input type="checkbox" name="attr_show_spell_level_1" class="ds-show-spell-level" />
              <div class="ds-spell-level-container">
                <div class="ds-spell-level-row">
                  <span>1st</span>
                  <span><input type="number" name="attr_spells_1" /></span>
                  <span><input type="checkbox" name="attr_spell1_1" /></span>
                  <span><input type="checkbox" name="attr_spell1_2" /></span>
                  <span><input type="checkbox" name="attr_spell1_3" /></span>
                  <span><input type="checkbox" name="attr_spell1_4" /></span>
                  <span><input type="checkbox" name="attr_spell1_5" /></span>
                  <span><input type="checkbox" name="attr_spell1_6" /></span>
                  <span><input type="checkbox" name="attr_spell1_7" /></span>
                  <span><input type="checkbox" name="attr_spell1_8" /></span>
                  <span><input type="checkbox" name="attr_spell1_9" /></span>
                </div>
              </div>
              <input type="checkbox" name="attr_show_spell_level_2" class="ds-show-spell-level" />
              <div class="ds-spell-level-container">
                <div class="ds-spell-level-row">
                  <span>2nd</span>
                  <span><input type="number" name="attr_spells_2" /></span>
                  <span><input type="checkbox" name="attr_spell2_1" /></span>
                  <span><input type="checkbox" name="attr_spell2_2" /></span>
                  <span><input type="checkbox" name="attr_spell2_3" /></span>
                  <span><input type="checkbox" name="attr_spell2_4" /></span>
                  <span><input type="checkbox" name="attr_spell2_5" /></span>
                  <span><input type="checkbox" name="attr_spell2_6" /></span>
                  <span><input type="checkbox" name="attr_spell2_7" /></span>
                  <span><input type="checkbox" name="attr_spell2_8" /></span>
                  <span><input type="checkbox" name="attr_spell2_9" /></span>
                </div>
              </div>
              <input type="checkbox" name="attr_show_spell_level_3" class="ds-show-spell-level" />
              <div class="ds-spell-level-container">
                <div class="ds-spell-level-row">
                  <span>3rd</span>
                  <span><input type="number" name="attr_spells_3" /></span>
                  <span><input type="checkbox" name="attr_spell3_1" /></span>
                  <span><input type="checkbox" name="attr_spell3_2" /></span>
                  <span><input type="checkbox" name="attr_spell3_3" /></span>
                  <span><input type="checkbox" name="attr_spell3_4" /></span>
                  <span><input type="checkbox" name="attr_spell3_5" /></span>
                  <span><input type="checkbox" name="attr_spell3_6" /></span>
                  <span><input type="checkbox" name="attr_spell3_7" /></span>
                  <span><input type="checkbox" name="attr_spell3_8" /></span>
                  <span><input type="checkbox" name="attr_spell3_9" /></span>
                </div>
              </div>
              <input type="checkbox" name="attr_show_spell_level_4" class="ds-show-spell-level" />
              <div class="ds-spell-level-container">
                <div class="ds-spell-level-row">
                  <span>4th</span>
                  <span><input type="number" name="attr_spells_4" /></span>
                  <span><input type="checkbox" name="attr_spell4_1" /></span>
                  <span><input type="checkbox" name="attr_spell4_2" /></span>
                  <span><input type="checkbox" name="attr_spell4_3" /></span>
                  <span><input type="checkbox" name="attr_spell4_4" /></span>
                  <span><input type="checkbox" name="attr_spell4_5" /></span>
                  <span><input type="checkbox" name="attr_spell4_6" /></span>
                  <span><input type="checkbox" name="attr_spell4_7" /></span>
                  <span><input type="checkbox" name="attr_spell4_8" /></span>
                  <span><input type="checkbox" name="attr_spell4_9" /></span>
                </div>
              </div>
              <input type="checkbox" name="attr_show_spell_level_5" class="ds-show-spell-level" />
              <div class="ds-spell-level-container">
                <div class="ds-spell-level-row">
                  <span>5th</span>
                  <span><input type="number" name="attr_spells_5" /></span>
                  <span><input type="checkbox" name="attr_spell5_1" /></span>
                  <span><input type="checkbox" name="attr_spell5_2" /></span>
                  <span><input type="checkbox" name="attr_spell5_3" /></span>
                  <span><input type="checkbox" name="attr_spell5_4" /></span>
                  <span><input type="checkbox" name="attr_spell5_5" /></span>
                  <span><input type="checkbox" name="attr_spell5_6" /></span>
                  <span><input type="checkbox" name="attr_spell5_7" /></span>
                  <span><input type="checkbox" name="attr_spell5_8" /></span>
                  <span><input type="checkbox" name="attr_spell5_9" /></span>
                </div>
              </div>
              <input type="checkbox" name="attr_show_spell_level_6" class="ds-show-spell-level" />
              <div class="ds-spell-level-container">
                <div class="ds-spell-level-row">
                  <span>6th</span>
                  <span><input type="number" name="attr_spells_6" /></span>
                  <span><input type="checkbox" name="attr_spell6_1" /></span>
                  <span><input type="checkbox" name="attr_spell6_2" /></span>
                  <span><input type="checkbox" name="attr_spell6_3" /></span>
                  <span><input type="checkbox" name="attr_spell6_4" /></span>
                  <span><input type="checkbox" name="attr_spell6_5" /></span>
                  <span><input type="checkbox" name="attr_spell6_6" /></span>
                  <span><input type="checkbox" name="attr_spell6_7" /></span>
                  <span><input type="checkbox" name="attr_spell6_8" /></span>
                  <span><input type="checkbox" name="attr_spell6_9" /></span>
                </div>
              </div>
              <input type="checkbox" name="attr_show_spell_level_7" class="ds-show-spell-level" />
              <div class="ds-spell-level-container">
                <div class="ds-spell-level-row">
                  <span>7th</span>
                  <span><input type="number" name="attr_spells_7" /></span>
                  <span><input type="checkbox" name="attr_spell7_1" /></span>
                  <span><input type="checkbox" name="attr_spell7_2" /></span>
                  <span><input type="checkbox" name="attr_spell7_3" /></span>
                  <span><input type="checkbox" name="attr_spell7_4" /></span>
                  <span><input type="checkbox" name="attr_spell7_5" /></span>
                  <span><input type="checkbox" name="attr_spell7_6" /></span>
                  <span><input type="checkbox" name="attr_spell7_7" /></span>
                  <span><input type="checkbox" name="attr_spell7_8" /></span>
                  <span><input type="checkbox" name="attr_spell7_9" /></span>
                </div>
              </div>
              <input type="checkbox" name="attr_show_spell_level_8" class="ds-show-spell-level" />
              <div class="ds-spell-level-container">
                <div class="ds-spell-level-row">
                  <span>8th</span>
                  <span><input type="number" name="attr_spells_8" /></span>
                  <span><input type="checkbox" name="attr_spell8_1" /></span>
                  <span><input type="checkbox" name="attr_spell8_2" /></span>
                  <span><input type="checkbox" name="attr_spell8_3" /></span>
                  <span><input type="checkbox" name="attr_spell8_4" /></span>
                  <span><input type="checkbox" name="attr_spell8_5" /></span>
                  <span><input type="checkbox" name="attr_spell8_6" /></span>
                  <span><input type="checkbox" name="attr_spell8_7" /></span>
                  <span><input type="checkbox" name="attr_spell8_8" /></span>
                  <span><input type="checkbox" name="attr_spell8_9" /></span>
                </div>
              </div>
              <input type="checkbox" name="attr_show_spell_level_9" class="ds-show-spell-level" />
              <div class="ds-spell-level-container">
                <div class="ds-spell-level-row">
                  <span>9th</span>
                  <span><input type="number" name="attr_spells_9" /></span>
                  <span><input type="checkbox" name="attr_spell9_1" /></span>
                  <span><input type="checkbox" name="attr_spell9_2" /></span>
                  <span><input type="checkbox" name="attr_spell9_3" /></span>
                  <span><input type="checkbox" name="attr_spell9_4" /></span>
                  <span><input type="checkbox" name="attr_spell9_5" /></span>
                  <span><input type="checkbox" name="attr_spell9_6" /></span>
                  <span><input type="checkbox" name="attr_spell9_7" /></span>
                  <span><input type="checkbox" name="attr_spell9_8" /></span>
                  <span><input type="checkbox" name="attr_spell9_9" /></span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <input type="checkbox" name="attr_show_thief_skills" class="ds-show-thief-skills" style="display: none;" />

        <!-- THIEF SKILLS SECTION -->
        <div class="ds-thief-skills-section">
          <h3>THIEF SKILLS</h3>
          <div class="ds-thief-skills-grid">
            <div class="ds-thief-skill">
              <label>Pick Pockets</label>
              <input type="number" name="attr_pick_pockets" />
              <button type="roll"
                value="&{template:ds-check} {{title=Pick Pockets Check}} {{subtitle=for @{character_name}}} {{checkroll=[[1d100cs<1cf>[[@{pick_pockets} + 15]]-(?{Misc Modifier?|0})]]}} {{checktarget=[[@{pick_pockets}]]}} {{success=You pilfer successfully!}} {{fail=You fail to steal anything.}} {{fumble=You get caught!}}"></button>
            </div>
            <div class="ds-thief-skill">
              <label>Open Locks</label>
              <input type="number" name="attr_open_locks" />
              <button type="roll"
                value="&{template:ds-check} {{title=Open Locks Check}} {{subtitle=for @{character_name}}} {{checkroll=[[1d100cs<1cf>100-(?{Misc Modifier?|0})]]}} {{checktarget=[[@{open_locks}]]}} {{success=You pick the lock!}} {{fail=The lock remains closed.}}"></button>
            </div>
            <div class="ds-thief-skill">
              <label>Find/Remove Traps</label>
              <input type="number" name="attr_find_remove_traps" />
              <button type="roll"
                value="&{template:ds-check} {{title=Find/Remove Traps Check}} {{subtitle=for @{character_name}}} {{checkroll=[[1d100cs<1cf>100-(?{Misc Modifier?|0})]]}} {{checktarget=[[@{find_remove_traps}]]}} {{success=You handle the trap!}} {{fail=You fail to deal with the trap.}}"></button>
            </div>
            <div class="ds-thief-skill">
              <label>Move Silently</label>
              <input type="number" name="attr_move_silently" />
              <button type="roll"
                value="&{template:ds-check} {{title=Move Silently Check}} {{subtitle=for @{character_name}}} {{checkroll=[[1d100cs<1cf>100-(?{Misc Modifier?|0})]]}} {{checktarget=[[@{move_silently}]]}} {{success=You move without sound!}} {{fail=Your movement makes noise.}} {{fumble=You make a loud noise!}}"></button>
            </div>
            <div class="ds-thief-skill">
              <label>Hide in Shadows</label>
              <input type="number" name="attr_hide_shadows" />
              <button type="roll"
                value="&{template:ds-check} {{title=Hide in Shadows Check}} {{subtitle=for @{character_name}}} {{checkroll=[[1d100cs<1cf>100-(?{Misc Modifier?|0})]]}} {{checktarget=[[@{hide_shadows}]]}} {{success=You hide successfully!}} {{fail=You remain visible.}} {{fumble=You draw attention to yourself!}}"></button>
            </div>
            <div class="ds-thief-skill">
              <label>Climb Walls</label>
              <input type="number" name="attr_climb_walls" />
              <button type="roll"
                value="&{template:ds-check} {{title=Climb Walls Check}} {{subtitle=for @{character_name}}} {{checkroll=[[1d100cs<1cf>100-(?{Misc Modifier?|0})]]}} {{checktarget=[[@{climb_walls}]]}} {{success=You climb successfully!}} {{fail=You fail to climb.}}"></button>
            </div>
            <div class="ds-thief-skill">
              <label>Hear Noise (d6)</label>
              <input type="number" name="attr_hear_noise" max="6" />
              <button type="roll"
                value="&{template:ds-check} {{title=Hear Noise Check}} {{subtitle=for @{character_name}}} {{checkroll=[[1d6cs<1cf>6-(?{Misc Modifier?|0})]]}} {{checktarget=[[@{hear_noise}]]}} {{success=You hear something!}} {{fail=You hear nothing unusual.}}"></button>
            </div>
            <div class="ds-thief-skill">
              <label>Appraise (d6)</label>
              <input type="number" name="attr_appraise" max="6" />
              <button type="roll"
                value="&{template:ds-check} {{title=Appraise Check}} {{subtitle=for @{character_name}}} {{checkroll=[[1d6cs<1cf>6-(?{Misc Modifier?|0})]]}} {{checktarget=[[@{appraise}]]}} {{success=You assess the value accurately!}} {{fail=You misjudge the value.}} {{fumble=You greatly misjudge the value!}}"></button>
            </div>
          </div>
        </div>

        <!-- HENCHMEN & HIRELINGS -->
        <div class="ds-henchmen-section">
          <h3>HENCHMEN & HIRELINGS</h3>
          <div class="ds-henchmen-header">
            <span class="ds-henchmen-label">Name</span>
            <span class="ds-henchmen-label">Class</span>
            <span class="ds-henchmen-label">Lvl.</span>
            <span class="ds-henchmen-label">HP</span>
            <span class="ds-henchmen-label">AC</span>
            <span class="ds-henchmen-label">Armor</span>
            <span class="ds-henchmen-label">XP</span>
            <span class="ds-henchmen-label">Weapon</span>
            <span class="ds-henchmen-label">DMG.</span>
          </div>
          <fieldset class="repeating_henchmen">
            <div class="ds-henchmen-row">
              <input type="text" name="attr_hench_name" class="ds-henchmen-input" />
              <input type="text" name="attr_hench_class" class="ds-henchmen-input" />
              <input type="number" name="attr_hench_level" class="ds-henchmen-input" />
              <input type="number" name="attr_hench_hp" class="ds-henchmen-input" />
              <input type="number" name="attr_hench_ac" class="ds-henchmen-input" />
              <input type="text" name="attr_hench_armor" class="ds-henchmen-input" />
              <input type="number" name="attr_hench_xp" class="ds-henchmen-input" />
              <input type="text" name="attr_hench_weapon" class="ds-henchmen-input" />
              <input type="text" name="attr_hench_dmg" class="ds-henchmen-input" />
            </div>
          </fieldset>
        </div>
      </div>
    </div>
  </div>

  <input type="checkbox" id="notes_content" name="attr_show_notes" class="ds-tab-content-control">
  <div id="notes" class="ds-tab-content">
    <textarea class="ds-notes-input" placeholder="Enter your notes here..."></textarea>
  </div>

  <input type="checkbox" id="spells_content" name="attr_show_spells" class="ds-tab-content-control">
  <div id="spells" class="ds-tab-content">
    <div class="ds-spellbook-placeholder">Spellbook content goes here...</div>
  </div>
</template>

<script type="text/worker">
  on("change:strength", function () {
    getAttrs(["strength"], function (values) {
      let str = parseInt(values.strength) || 0;
      let strBonus = str < 4 ? -3 : str < 6 ? -2 : str < 9 ? -1 : str < 13 ? 0 : str < 16 ? 1 : str < 18 ? 2 : 3;
      setAttrs({
        "str_melee_mod": strBonus,
        "str_force_door": strBonus
      });
    });
  });
  on("change:dexterity", function () {
    getAttrs(["dexterity"], function (values) {
      let dex = parseInt(values.dexterity) || 0;
      let dexBonus = dex < 4 ? -3 : dex < 6 ? -2 : dex < 9 ? -1 : dex < 13 ? 0 : dex < 16 ? 1 : dex < 18 ? 2 : 3;
      setAttrs({
        "dex_missile": dexBonus,
        "dex_armor": -dexBonus
      });
    });
  });
  on("change:constitution", function () {
    getAttrs(["constitution"], function (values) {
      let con = parseInt(values.constitution) || 0;
      let conBonus = con < 4 ? -3 : con < 6 ? -2 : con < 9 ? -1 : con < 13 ? 0 : con < 16 ? 1 : con < 18 ? 2 : 3;
      setAttrs({
        "con_hp": conBonus
      });
    });
  });
  on("change:charisma", function () {
    getAttrs(["charisma"], function (values) {
      let cha = parseInt(values.charisma) || 0;
      let henchmen = cha < 4 ? 0 : cha < 6 ? 1 : cha < 9 ? 2 : cha < 13 ? 3 : cha < 16 ? 4 : cha < 18 ? 5 : 6;
      let morale = cha < 4 ? 4 : cha < 6 ? 5 : cha < 9 ? 6 : cha < 13 ? 7 : cha < 16 ? 8 : cha < 18 ? 9 : 10;
      setAttrs({
        "cha_henchmen": henchmen,
        "cha_morale": morale
      });
    });
  });
  on("change:intelligence", function () {
    getAttrs(["intelligence"], function (values) {
      let int = parseInt(values.intelligence) || 0;
      let languages = int < 4 ? -3 : int < 6 ? -2 : int < 9 ? -1 : int < 13 ? 0 : int < 16 ? 1 : int < 18 ? 2 : 3;
      setAttrs({
        "int_languages": languages
      });
    });
  });
  on("change:wisdom", function () {
    getAttrs(["wisdom"], function (values) {
      let wis = parseInt(values.wisdom) || 0;
      let magicSave = wis < 4 ? -3 : wis < 6 ? -2 : wis < 9 ? -1 : wis < 13 ? 0 : wis < 16 ? 1 : wis < 18 ? 2 : 3;
      setAttrs({
        "wis_magic_save": magicSave
      });
    });
  });
  on("change:class change:level", function () {
    getAttrs(["class", "level", "save_breath_race_bonus", "save_death_race_bonus", "save_stone_race_bonus", "save_wand_race_bonus", "save_spell_race_bonus"], function (values) {
      let classType = values.class;
      let level = parseInt(values.level) || 1;
      let bab = 0;
      let hd = "d8";
      let titles = [];
      let saves = [16, 14, 15, 16, 17];
      let saveRaceMods = [
        parseInt(values.save_breath_race_bonus) || 0,
        parseInt(values.save_death_race_bonus) || 0,
        parseInt(values.save_stone_race_bonus) || 0,
        parseInt(values.save_wand_race_bonus) || 0,
        parseInt(values.save_spell_race_bonus) || 0
      ];
      if (classType === "Cleric" || classType === "Druid" || classType == "Monk") {
        bab = level < 4 ? 0 : level < 5 ? 1 : level < 7 ? 2 : level < 10 ? 3 : 4;
        hd = "d8";
        saves = level < 4 ? [16, 10, 13, 14, 15] : level < 7 ? [15, 9, 12, 13, 14] : level < 10 ? [13, 7, 10, 11, 12] : level < 13 ? [12, 6, 9, 10, 11] : level < 16 ? [11, 5, 8, 9, 10] : level < 19 ? [10, 4, 7, 8, 9] : [8, 2, 5, 6, 7];
        if (classType === "Cleric") {
          titles = ["Acolyte", "Acolyte", "Devotee", "Holy Man", "Zealot", "Priest", "Crusader", "Templar", "Ecclesiarch", "Bishop", "High Priest"];
        } else if (classType === "Druid") {
          titles = ["Soothsayer", "Soothsayer", "Ovate of Spring", "Ovate of Summer", "Ovate of Autumn", "Ovate of Winter", "Ovate of Nature", "Voice of Nature", "Hand of Nature", "Wrath of Nature", "Archdruid"];
        } else if (classType === "Monk") {
          titles = ["Postulant", "Postulant", "Mendicant", "Brother", "Pilgrim", "Friar", "Monastic", "Cenobite", "Ascetic", "Prelate", "Abbot"];
        }
      } else if (classType === "Fighter" || classType === "Paladin" || classType === "Ranger" || classType === "Barbarian") {
        bab = Math.max(0, level - 2);
        hd = "d10";
        saves = level < 1 ? [17, 16, 17, 18, 19] : level < 3 ? [16, 14, 15, 16, 17] : level < 5 ? [15, 13, 14, 15, 16] : level < 7 ? [13, 11, 12, 13, 14] : level < 9 ? [12, 10, 11, 12, 13] : level < 11 ? [11, 9, 10, 11, 12] : level < 13 ? [8, 7, 8, 9, 10] : level < 15 ? [5, 5, 6, 7, 8] : level < 17 ? [4, 4, 5, 6, 7] : [4, 3, 4, 5, 6];
        if (classType === "Fighter") {
          titles = ["Swordsman", "Swordsman", "Freebooter", "Sellsword", "Veteran", "Warrior", "Myrmidon", "Axe Master", "Battle Master", "Champion", "Warlord"];
        } else if (classType === "Barbarian") {
          titles = ["Brawler", "Brawler", "Pillager", "Marauder", "Reaver", "Berserker", "Ravager", "Axe Master", "Battle Master", "Battle Lord", "Barbarian King"];
          // Barbarians get save bonuses
          let barbSaveMods = [2, 4, 3, 3, 2];
          saves = saves.map((save, index) => save - barbSaveMods[index]);
        } else if (classType === "Paladin") {
          titles = ["Squire", "Squire", "Cavalier", "Knight-Errant", "Knight-Vigilant", "Knight-Banneret", "Knight-Gallant", "Knight-Crusader", "Knight-Templar", "Knight-Protector", "Knight of the Rose"];
          // Paladins get +2 to all saves
          saves = saves.map(save => save - 2);
        } else if (classType === "Ranger") {
          titles = ["Hunter", "Hunter", "Wanderer", "Rover", "Scout", "Gadabout", "Strider", "Master Scout", "Outrider", "Pathfinder", "Ranger Lord"];
        }
      } else if (classType === "Magic-User" || classType === "Illusionist") {
        bab = level < 4 ? 0 : level < 8 ? 1 : 2;
        hd = "d4";
        saves = level < 6 ? [15, 14, 13, 11, 12] : level < 11 ? [13, 13, 11, 9, 10] : level < 16 ? [11, 11, 9, 7, 8] : level < 21 ? [9, 10, 7, 5, 6] : [7, 8, 5, 3, 4];
        if (classType === "Magic-User") {
          titles = ["Channeler", "Channeler", "Spellweaver", "Magician", "Enchanter", "Mage", "Summoner", "Magister", "Warlock", "Archmage", "Grand Mage"];
        } else if (classType === "Illusionist") {
          titles = ["Prestidigitator", "Prestidigitator", "Charmer", "Dazzler", "Glamourer", "Hypnotist", "Illusioneer", "Beguiler", "Phantasmalist", "Thaumaturge", "Arch Beguiler"];
        }
      } else if (classType === "Thief" || classType === "Assassin") {
        bab = level < 4 ? 0 : level < 6 ? 1 : level < 8 ? 2 : level < 10 ? 3 : 4;
        hd = "d6";
        saves = level < 5 ? [16, 13, 12, 14, 15] : level < 9 ? [15, 12, 11, 12, 13] : level < 13 ? [14, 11, 10, 10, 11] : level < 17 ? [12, 10, 9, 8, 9] : [11,9,8,6,7];
        if (classType === "Thief") {
          titles = ["Thug", "Thug", "Knave", "Purse-Cutter", "Charlatan", "Blackguard", "Vagabond", "Sneak-Thief", "Burglar", "Master Thief", "Guildmaster"];
        } else if (classType === "Assassin") {
          titles = ["Throat-Cutter", "Throat-Cutter", "Garotteur", "Murderer", "Backbiter", "Master Garotteur", "Silent Killer", "Death Dealer", "Slayer", "Assassin", "Guildmaster"];
        }
      }
      setAttrs({
        "attack_bonus": bab,
        "hit_die": hd,
        "title": titles[Math.min(level, 10)] || "",
        "save_breath": saves[0] - saveRaceMods[0],
        "save_death": saves[1] - saveRaceMods[1],
        "save_stone": saves[2] - saveRaceMods[2],
        "save_wand": saves[3] - saveRaceMods[3],
        "save_spell": saves[4] - saveRaceMods[4]
      });
    });
  });
  on("change:class change:strength change:intelligence change:wisdom change:dexterity change:constitution change:charisma", function () {
    getAttrs(["class", "strength", "intelligence", "wisdom", "dexterity", "constitution", "charisma"], function (values) {
      const classType = values.class;

      // Determine prime attribute based on class
      let primeAttributes = [];

      switch (classType) {
        case "Cleric":
          primeAttributes = ["wisdom"];
          break;
        case "Druid":
          primeAttributes = ["wisdom", "charisma"];
          break;
        case "Monk":
          primeAttributes = ["wisdom", "intelligence"];
          break;
        case "Fighter":
          primeAttributes = ["strength"];
          break;
        case "Barbarian":
          primeAttributes = ["strength", "constitution"];
          break;
        case "Paladin":
          primeAttributes = ["strength", "charisma"];
          break;
        case "Ranger":
          primeAttributes = ["strength", "intelligence", "wisdom"];
          break;
        case "Magic-User":
          primeAttributes = ["intelligence"];
          break;
        case "Illusionist":
          primeAttributes = ["intelligence"];
          break;
        case "Thief":
          primeAttributes = ["dexterity"];
          break;
        case "Assassin":
          primeAttributes = ["dexterity", "intelligence"];
          break;
        default:
          primeAttributes = [];
      }

      // Calculate XP bonus based on prime attribute scores
      let compoundXP = 1.0;
      primeAttributes.forEach(primeAttribute => {
        const primeScore = parseInt(values[primeAttribute]) || 0;
        if (primeScore >= 16) {
          compoundXP *= 1.1;
        } else if (primeScore >= 13) {
          compoundXP *= 1.05;
        } else if (primeScore <= 8) {
          compoundXP *= 0.95;
        } else if (primeScore <= 5) {
          compoundXP *= 0.9;
        }
      });
      setAttrs({
        "xp_bonus": Math.round(Number.parseFloat(Number.parseFloat((compoundXP - 1) * 100).toFixed(1)))
      });
    });
  });
  on("change:race", function (eventInfo) {
    getAttrs(["race", "save_breath", "save_death", "save_spell", "save_stone", "save_wand", "save_breath_race_bonus", "save_death_race_bonus", "save_spell_race_bonus", "save_stone_race_bonus", "save_wand_race_bonus"], function (values) {
      let moveRate = 40; // Default human move rate
      let missileMod = 0;
      let breathBonus = parseInt(values.save_breath_race_bonus) || 0;
      let deathBonus = parseInt(values.save_death_race_bonus) || 0;
      let stoneBonus = parseInt(values.save_stone_race_bonus) || 0;
      let wandBonus = parseInt(values.save_wand_race_bonus) || 0;
      let spellBonus = parseInt(values.save_spell_race_bonus) || 0;
      let breath = (parseInt(values.save_breath) || 0) + breathBonus;
      let death = (parseInt(values.save_death) || 0) + deathBonus;
      let stone = (parseInt(values.save_stone) || 0) + stoneBonus;
      let wand = (parseInt(values.save_wand) || 0) + wandBonus;
      let spell = (parseInt(values.save_spell) || 0) + spellBonus;
      breathBonus = 0;
      deathBonus = 0;
      stoneBonus = 0;
      wandBonus = 0;
      spellBonus = 0;
      const race = values.race;
      // Set move rate and bonuses based on race
      switch (race) {
        case "Human":
          moveRate = 40;
          break;
        case "Cyclopsman":
          moveRate = 40;
          missileMod = -2;
          break;
        case "Dwarf":
          moveRate = 20;
          breathBonus = 2;
          deathBonus = 4;
          stoneBonus = 4;
          wandBonus = 3;
          spellBonus = 4;
          break;
        case "Elf":
          moveRate = 40;
          break;
        case "Gnome":
          moveRate = 20;
          breathBonus = 2;
          deathBonus = 4;
          stoneBonus = 4;
          wandBonus = 1;
          spellBonus = 2;
          break;
        case "Halfling":
          moveRate = 20;
          breathBonus = 2;
          deathBonus = 4;
          stoneBonus = 4;
          wandBonus = 3;
          spellBonus = 4;
          break;
        case "Half-Elf":
          moveRate = 40;
          break;
        case "Half-Orc":
          moveRate = 40;
          break;
        default:
          moveRate = 40; // Default to human move rate
      }
      setAttrs({
        "move": moveRate,
        "missile_race_mod": missileMod,
        "save_breath": breath - breathBonus,
        "save_breath_race_bonus": breathBonus,
        "save_death": death - deathBonus,
        "save_death_race_bonus": deathBonus,
        "save_stone": stone - stoneBonus,
        "save_stone_race_bonus": stoneBonus,
        "save_wand": wand - wandBonus,
        "save_wand_race_bonus": wandBonus,
        "save_spell": spell - spellBonus,
        "save_spell_race_bonus": spellBonus
      });
    });
  });
  on("change:class change:level", function () {
    getAttrs(["class", "level"], function (values) {
      const classType = values.class;
      const level = parseInt(values.level) || 1;

      // Show thief skills only for Thief and Assassin classes (Assassin at 3+)
      const showThiefSkills = classType === "Thief" || (classType === "Assassin" && level >= 3);
      
      // Calculate effective thief level for skill lookup
      let effectiveLevel = 0;
      if (classType === "Thief") {
        effectiveLevel = level;
      } else if (classType === "Assassin" && level >= 3) {
        effectiveLevel = Math.max(1, level - 2); // Assassins are 2 levels behind
      }

      // Lookup tables for thief skills
      const skillLevels = {
        pick_pockets: [35, 40, 45, 50, 55, 60, 65, 70, 80, 90, 99, 99, 99, 99, 99],
        open_locks: [35, 40, 45, 50, 55, 60, 65, 70, 75, 80, 85, 90, 95, 99, 99],
        find_remove_traps: [35, 37, 40, 45, 50, 55, 60, 65, 70, 75, 80, 85, 90, 95, 99],
        move_silently: [33, 37, 40, 43, 50, 60, 70, 80, 90, 99, 99, 99, 99, 99, 99],
        hide_shadows: [25, 27, 30, 35, 37, 40, 50, 60, 70, 80, 90, 99, 99, 99, 99],
        climb_walls: [85, 86, 87, 88, 90, 92, 94, 96, 98, 99, 99, 99, 99, 99, 99],
        hear_noise: [2, 2, 3, 3, 3, 4, 4, 4, 4, 5, 5, 5, 5, 5, 5],
        appraise: [2, 2, 3, 3, 3, 4, 4, 4, 4, 5, 5, 5, 5, 5, 5]
      };

      // If showing thief skills, set the values
      if (showThiefSkills) {
        const idx = Math.min(effectiveLevel - 1, 14); // Array is 0-based, cap at 15th level
        const updates = {
          "show_thief_skills": "on",
          "base_pick_pockets": skillLevels.pick_pockets[idx],
          "base_open_locks": skillLevels.open_locks[idx],
          "base_find_remove_traps": skillLevels.find_remove_traps[idx],
          "base_move_silently": skillLevels.move_silently[idx],
          "base_hide_shadows": skillLevels.hide_shadows[idx],
          "base_climb_walls": skillLevels.climb_walls[idx],
          "base_hear_noise": skillLevels.hear_noise[idx],
          "base_appraise": skillLevels.appraise[idx]
        };
        setAttrs(updates);
      } else {
        // Hide thief skills section
        setAttrs({
          "show_thief_skills": "0"
        });
      }
      
      // Show turn undead only for Clerics
      const showTurnUndead = classType === "Cleric" || 
                            ((classType === "Paladin" || classType === "Monk") && level >= 3);
      
      setAttrs({
        "show_thief_skills": showThiefSkills ? "on" : "0",
        "show_turn_undead": showTurnUndead ? "on" : "0"
      });
    });
  });
  on("change:race change:base_pick_pockets change:base_open_locks change:base_find_remove_traps change:base_move_silently change:base_hide_shadows change:base_climb_walls change:base_hear_noise change:base_appraise", function() {
    getAttrs(["race"], function(values) {
      const race = values.race;
      let updates = {
        // Initialize all racial bonuses to 0
        "racial_pick_pockets": 0,
        "racial_open_locks": 0,
        "racial_find_remove_traps": 0,
        "racial_move_silently": 0,
        "racial_hide_shadows": 0,
        "racial_climb_walls": 0,
        "racial_hear_noise": 0,
        "racial_appraise": 0
      };

      // Set racial bonuses based on race
      switch (race) {
        case "Dwarf":
          updates.racial_pick_pockets = 7;
          updates.racial_find_remove_traps = 10;
          updates.racial_climb_walls = -10;
          break;
        case "Elf":
          updates.racial_pick_pockets = 5;
          updates.racial_open_locks = -5;
          updates.racial_move_silently = 7;
          updates.racial_hide_shadows = 10;
          updates.racial_hear_noise = 1;
          break;
        case "Gnome":
          updates.racial_open_locks = 5;
          updates.racial_find_remove_traps = 7;
          updates.racial_move_silently = 5;
          updates.racial_hide_shadows = 5;
          updates.racial_climb_walls = -15;
          break;
        case "Halfling":
          updates.racial_pick_pockets = 5;
          updates.racial_open_locks = 5;
          updates.racial_find_remove_traps = 5;
          updates.racial_move_silently = 10;
          updates.racial_hide_shadows = 10;
          updates.racial_climb_walls = -15;
          break;
        case "Half-Elf":
          updates.racial_pick_pockets = 10;
          updates.racial_hide_shadows = 5;
          break;
        case "Half-Orc":
          updates.racial_pick_pockets = -5;
          updates.racial_open_locks = 5;
          updates.racial_find_remove_traps = 5;
          updates.racial_climb_walls = 5;
          break;
      }

      // Set the racial bonus values
      setAttrs(updates, {}, () => {
        // After setting racial bonuses, trigger recalculation of final values
        getAttrs([
          "base_pick_pockets", "racial_pick_pockets",
          "base_open_locks", "racial_open_locks",
          "base_find_remove_traps", "racial_find_remove_traps",
          "base_move_silently", "racial_move_silently",
          "base_hide_shadows", "racial_hide_shadows",
          "base_climb_walls", "racial_climb_walls",
          "base_hear_noise", "racial_hear_noise",
          "base_appraise", "racial_appraise"
        ], function(v) {
          // Calculate final values
          const finalUpdates = {
            "pick_pockets": parseInt(v.base_pick_pockets || 0) + parseInt(v.racial_pick_pockets || 0),
            "open_locks": parseInt(v.base_open_locks || 0) + parseInt(v.racial_open_locks || 0),
            "find_remove_traps": parseInt(v.base_find_remove_traps || 0) + parseInt(v.racial_find_remove_traps || 0),
            "move_silently": parseInt(v.base_move_silently || 0) + parseInt(v.racial_move_silently || 0),
            "hide_shadows": parseInt(v.base_hide_shadows || 0) + parseInt(v.racial_hide_shadows || 0),
            "climb_walls": parseInt(v.base_climb_walls || 0) + parseInt(v.racial_climb_walls || 0),
            "hear_noise": parseInt(v.base_hear_noise || 0) + parseInt(v.racial_hear_noise || 0),
            "appraise": parseInt(v.base_appraise || 0) + parseInt(v.racial_appraise || 0)
          };
          setAttrs(finalUpdates);
        });
      });
    });
  });

  on("change:level change:class", function() {
    getAttrs(["level", "class"], function(values) {
      const level = parseInt(values.level) || 1;
      const classType = values.class;
      
      // Only show turn undead for Clerics
      const showTurnUndead = classType === "Cleric" || 
                            ((classType === "Paladin" || classType === "Monk") && level >= 3);
      
      setAttrs({
        "show_turn_undead": showTurnUndead ? "on" : "0"
      });
    });
  });

  // Custom Roll Parsing for Turn Undead
  on("clicked:turn_undead", function(info) {
    getAttrs(["turn_undead_charges", "level", "class"], function(values) {
        const charges = parseInt(values.turn_undead_charges, 10) || 0;
        if (charges > 0) { setAttrs({"turn_undead_charges": charges - 1}); }
        startRoll("&{template:ds-turn} {{title=Turn Undead}} {{charges=@{turn_undead_charges}}} {{subtitle=for @{character_name}}} {{level=@{level}}} {{turncount=[[2d4+1]]}} {{roll=[[1d20 - (3 - " + charges + ") + (?{Roleplaying Bonus?|0})]]}}", function(results) {
          const TURN_UNDEAD_TABLE = {
            1: [11, 14, 17, 19, 20, null, null, null, null, null],
            2: [8, 11, 14, 17, 19, 20, null, null, null, null],
            3: [5, 8, 11, 14, 17, 19, 20, null, null, null],
            4: ["T", "T", 5, 8, 11, 14, 17, 20, null, null],
            5: ["T", "T", "T", 5, 8, 11, 14, 17, 20, null],
            6: ["D", "D", "T", "T", 5, 8, 11, 14, 17, 20],
            7: ["D", "D", "D", "T", "T", 5, 8, 11, 14, 17],
            8: ["D", "D", "D", "D", "T", "T", 5, 8, 11, 14],
            9: ["D", "D", "D", "D", "D", "T", "T", 5, 8, 11],
            10:["D", "D", "D", "D", "D", "D", "T", "T", 5, 8]
          };

          const classType = values.class;
          const level = classType === "Cleric" ? (parseInt(values.level) || 1) : (parseInt(values.level) || 3) - 2;
          const clampedLevel = Math.min(Math.max(level, 1), 10);
          const tableRow = TURN_UNDEAD_TABLE[clampedLevel];
          const d20Roll = results.results.roll.result;
          const charges = parseInt(values.turn_undead_charges, 10) || 0;

          const convertEntry = (entry) => {
            if (entry === null) return Number.MAX_SAFE_INTEGER;
            if (entry === "D" || entry === "T") return Number.MIN_SAFE_INTEGER;
            return entry;
          };

          let maxHD = 0;
          let maxDestroy = 0;

          for (let i = 0; i < tableRow.length; i++) {
            const value = convertEntry(tableRow[i]);
            if (tableRow[i] === "D") {
              maxDestroy = i + 1;
            } else if (d20Roll >= value) {
              maxHD = i + 1;
            }
          }

          const turnResult = charges <= 0 ? "No turn charges left" : maxHD === 0 ? "Failed to turn any undead" : 
                           maxHD === 10 ? "Turns undead of any HD" :
                           `Maximum HD of turned creature: ${maxHD}`;
          const turnDestroy = charges <= 0 ? "" : maxDestroy > 0 ? `${maxDestroy} HD undead and lower are completely obliterated!` : "";

          finishRoll(results.rollId, {
            roll: turnResult,
            turncount: turnDestroy
          });
        });
    });
  });

  on("change:turn_undead_charges", function() {
    getAttrs(["turn_undead_charges"], function(values) {
      const charges = parseInt(values.turn_undead_charges, 10) || 0;
      setAttrs({
        "turn_undead_charges_greyed": charges <= 0 ? "1" : "0"
      });
    });
  })

  on("change:level change:class change:wisdom change:intelligence", function() {
    getAttrs(["class", "level", "wisdom", "intelligence"], function(values) {
      const classType = values.class;
      const level = parseInt(values.level) || 0;
      const isSpellcaster = ["Magic-User", "Illusionist", "Cleric", "Druid"].includes(classType) || (classType === "Monk" && level >= 3) || (classType === "Paladin" && level >= 9) || (classType === "Ranger" && level >= 9);
      const updates = {
        "show_spells": isSpellcaster ? "on" : "0"
      };
      let spellLevels = {};
      if (classType === "Cleric") {
        spellLevels = {
          1: 1,
          3: 2,
          5: 3,
          7: 4,
          9: 5,
          11: 6,
          16: 7
        };
      } else if (classType === "Druid") {
        spellLevels = {
          1: 1,
          2: 2,
          3: 3,
          6: 4,
          9: 5,
          11: 6,
          12: 7
        }
      } else if (classType === "Monk") {
        spellLevels = {
          3: 1,
          5: 2,
          7: 3,
          9: 4,
          11: 5,
          13: 6,
          18: 7
        }
      } else if (classType === "Paladin") {
        spellLevels = {
          9: 1,
          11: 2,
          13: 3,
          15: 4,
        }
      } else if (classType === "Ranger") {
        spellLevels = {
          9: 1,
          10: 2,
          11: 3,
          14: 4
        }
      } else if (classType === "Magic-User") {
        spellLevels = {
          1: 1,
          3: 2,
          5: 3,
          7: 4,
          9: 5,
          12: 6,
          14: 7,
          16: 8,
          18: 9
        }
      } else if (classType === "Illusionist") {
        spellLevels = {
          1: 1,
          3: 2,
          5: 3,
          8: 4,
          10: 5,
          12: 6,
          14: 7
        }
      }
      let maxSpellLevel = 0;
      for (const [lvl, spellLvl] of Object.entries(spellLevels)) {
        if (level >= parseInt(lvl)) {
          maxSpellLevel = parseInt(spellLvl);
        }
      }
      for (let i = 1; i <= 9; i++) {
        updates[`show_spell_level_${i}`] = i <= maxSpellLevel ? "on" : "0";
      }
      // Define spell progression for Cleric
      const clericSpellProgression = {
        0: [0, 0, 0, 0, 0, 0, 0],
        1: [1, 0, 0, 0, 0, 0, 0],
        2: [2, 0, 0, 0, 0, 0, 0],
        3: [2, 1, 0, 0, 0, 0, 0],
        4: [3, 2, 0, 0, 0, 0, 0],
        5: [3, 3, 1, 0, 0, 0, 0],
        6: [3, 3, 2, 0, 0, 0, 0],
        7: [3, 3, 2, 1, 0, 0, 0],
        8: [3, 3, 3, 2, 0, 0, 0],
        9: [4, 4, 3, 2, 1, 0, 0],
        10: [4, 4, 3, 3, 2, 0, 0],
        11: [5, 4, 4, 3, 2, 1, 0],
        12: [6, 5, 5, 3, 2, 2, 0],
        13: [6, 6, 6, 4, 2, 2, 0],
        14: [6, 6, 6, 5, 3, 2, 0],
        15: [7, 7, 7, 5, 4, 2, 0],
        16: [7, 7, 7, 6, 5, 3, 1],
        17: [8, 8, 8, 6, 5, 3, 1],
        18: [8, 8, 8, 7, 6, 4, 1],
        19: [9, 9, 9, 7, 6, 4, 2],
        20: [9, 9, 9, 8, 7, 5, 2]
      };

      const druidSpellProgression = {
        0: [0, 0, 0, 0, 0, 0, 0],
        1: [2, 0, 0, 0, 0, 0, 0],
        2: [2, 1, 0, 0, 0, 0, 0],
        3: [3, 2, 1, 0, 0, 0, 0],
        4: [4, 2, 2, 0, 0, 0, 0],
        5: [4, 3, 2, 0, 0, 0, 0],
        6: [4, 3, 2, 1, 0, 0, 0],
        7: [4, 4, 3, 1, 0, 0, 0],
        8: [4, 4, 3, 2, 0, 0, 0],
        9: [5, 4, 3, 2, 1, 0, 0],
        10: [5, 4, 3, 3, 2, 0, 0],
        11: [5, 5, 3, 3, 2, 1, 0],
        12: [5, 5, 4, 4, 3, 2, 1],
        13: [6, 5, 5, 5, 4, 3, 2],
        14: [6, 6, 6, 6, 5, 4, 3],
        15: [7, 7, 7, 6, 6, 4, 3],
        16: [7, 7, 7, 7, 6, 5, 4],
        17: [8, 8, 8, 8, 6, 5, 4],
        18: [8, 8, 8, 8, 7, 6, 4],
        19: [9, 9, 9, 9, 7, 6, 5],
        20: [9, 9, 9, 9, 8, 7, 5]
      };

      const monkSpellProgression = {
        0: [0, 0, 0, 0, 0, 0, 0],
        1: [0, 0, 0, 0, 0, 0, 0],
        2: [0, 0, 0, 0, 0, 0, 0],
        3: [1, 0, 0, 0, 0, 0, 0],
        4: [2, 0, 0, 0, 0, 0, 0],
        5: [2, 1, 0, 0, 0, 0, 0],
        6: [3, 2, 0, 0, 0, 0, 0],
        7: [3, 3, 1, 0, 0, 0, 0],
        8: [3, 3, 2, 0, 0, 0, 0],
        9: [3, 3, 2, 1, 0, 0, 0],
        10: [3, 3, 3, 2, 0, 0, 0],
        11: [4, 4, 3, 2, 1, 0, 0],
        12: [4, 4, 3, 3, 2, 0, 0],
        13: [5, 4, 4, 3, 2, 1, 0],
        14: [6, 5, 5, 3, 2, 2, 0],
        15: [6, 6, 6, 4, 2, 2, 0],
        16: [6, 6, 6, 5, 3, 2, 0],
        17: [7, 7, 7, 5, 4, 2, 0],
        18: [7, 7, 7, 6, 5, 3, 1],
        19: [8, 8, 8, 6, 5, 3, 1],
        20: [8, 8, 8, 7, 6, 4, 1]
      };

      const paladinSpellProgression = {
        0: [0, 0, 0, 0],
        1: [0, 0, 0, 0],
        2: [0, 0, 0, 0],
        3: [0, 0, 0, 0],
        4: [0, 0, 0, 0],
        5: [0, 0, 0, 0],
        6: [0, 0, 0, 0],
        7: [0, 0, 0, 0],
        8: [0, 0, 0, 0],
        9: [1, 0, 0, 0],
        10: [2, 0, 0, 0],
        11: [2, 1, 0, 0],
        12: [2, 2, 0, 0],
        13: [2, 2, 1, 0],
        14: [2, 2, 1, 0],
        15: [3, 2, 1, 1],
        16: [3, 3, 1, 1],
        17: [3, 3, 2, 1],
        18: [3, 3, 3, 1],
        19: [3, 3, 3, 2],
        20: [3, 3, 3, 3]
      };

      const rangerSpellProgression = {
        0: [0, 0, 0, 0],
        1: [0, 0, 0, 0],
        2: [0, 0, 0, 0],
        3: [0, 0, 0, 0],
        4: [0, 0, 0, 0],
        5: [0, 0, 0, 0],
        6: [0, 0, 0, 0],
        7: [0, 0, 0, 0],
        8: [0, 0, 0, 0],
        9: [2, 0, 0, 0],
        10: [2, 1, 0, 0],
        11: [3, 2, 1, 0],
        12: [4, 2, 2, 0],
        13: [4, 3, 2, 0],
        14: [4, 3, 2, 1],
        15: [4, 4, 3, 1],
        16: [4, 4, 3, 2],
        17: [5, 4, 3, 2],
        18: [5, 4, 3, 3],
        19: [5, 5, 3, 3],
        20: [5, 5, 4, 4]
      };

      const magicUserSpellProgression = {
        0: [0, 0, 0, 0, 0, 0, 0, 0, 0],
        1: [1, 0, 0, 0, 0, 0, 0, 0, 0],
        2: [2, 0, 0, 0, 0, 0, 0, 0, 0],
        3: [2, 1, 0, 0, 0, 0, 0, 0, 0],
        4: [3, 2, 0, 0, 0, 0, 0, 0, 0],
        5: [4, 2, 1, 0, 0, 0, 0, 0, 0],
        6: [4, 2, 2, 0, 0, 0, 0, 0, 0],
        7: [4, 3, 2, 1, 0, 0, 0, 0, 0],
        8: [4, 3, 3, 2, 0, 0, 0, 0, 0],
        9: [4, 3, 3, 2, 1, 0, 0, 0, 0],
        10: [4, 4, 3, 2, 2, 0, 0, 0, 0],
        11: [4, 4, 4, 3, 3, 0, 0, 0, 0],
        12: [4, 4, 4, 4, 4, 1, 0, 0, 0],
        13: [5, 5, 5, 4, 4, 2, 0, 0, 0],
        14: [5, 5, 5, 4, 4, 2, 1, 0, 0],
        15: [5, 5, 5, 5, 5, 2, 1, 0, 0],
        16: [5, 5, 5, 5, 5, 3, 2, 1, 0],
        17: [5, 5, 5, 5, 5, 3, 3, 2, 0],
        18: [5, 5, 5, 5, 5, 3, 3, 2, 1],
        19: [5, 5, 5, 5, 5, 3, 3, 3, 1],
        20: [5, 5, 5, 5, 5, 4, 3, 3, 2]
      };

      const illusionistSpellProgression = {
        0: [0, 0, 0, 0, 0, 0, 0],
        1: [1, 0, 0, 0, 0, 0, 0],
        2: [2, 0, 0, 0, 0, 0, 0],
        3: [2, 1, 0, 0, 0, 0, 0],
        4: [3, 2, 0, 0, 0, 0, 0],
        5: [4, 2, 1, 0, 0, 0, 0],
        6: [4, 3, 1, 0, 0, 0, 0],
        7: [4, 3, 2, 0, 0, 0, 0],
        8: [4, 3, 2, 1, 0, 0, 0],
        9: [5, 3, 3, 2, 0, 0, 0],
        10: [5, 4, 3, 2, 1, 0, 0],
        11: [5, 4, 3, 3, 2, 0, 0],
        12: [5, 5, 4, 3, 2, 1, 0],
        13: [5, 5, 4, 3, 2, 2, 0],
        14: [5, 5, 4, 3, 2, 2, 1],
        15: [5, 5, 4, 4, 2, 2, 1],
        16: [5, 5, 5, 4, 3, 2, 2],
        17: [5, 5, 5, 5, 3, 2, 2],
        18: [5, 5, 5, 5, 3, 3, 2],
        19: [5, 5, 5, 5, 4, 3, 2],
        20: [5, 5, 5, 5, 4, 3, 3]
      };
  
      let spellProgression = [];
      const wis = parseInt(values.wisdom) || 0;
      const int = parseInt(values.intelligence) || 0;
  
      switch (classType) {
        case "Cleric":
          spellProgression = clericSpellProgression[level] || clericSpellProgression[20];
          if (wis >= 15) {
            spellProgression[0] += 1;
            if (spellProgression[1] > 0) { spellProgression[1] += 1; }
          }
          break;
        case "Druid":
          spellProgression = druidSpellProgression[level] || druidSpellProgression[20];
          if (wis >= 15) {
            spellProgression[0] += 1;
            if (spellProgression[1] > 0) { spellProgression[1] += 1; }
          }
          break;
        case "Monk":
          spellProgression = monkSpellProgression[level] || monkSpellProgression[20];
          break;
        case "Paladin":
          spellProgression = paladinSpellProgression[level] || paladinSpellProgression[20];
          break;
        case "Ranger":
          spellProgression = rangerSpellProgression[level] || rangerSpellProgression[20];
          break;
        case "Magic-User":
          spellProgression = magicUserSpellProgression[level] || magicUserSpellProgression[20];
          if (int >= 15) {
            spellProgression[0] += 1;
            if (spellProgression[1] > 0) { spellProgression[1] += 1; }
          }
          break;
        case "Illusionist":
          spellProgression = illusionistSpellProgression[level] || illusionistSpellProgression[20];
          if (int >= 15) {
            spellProgression[0] += 1;
            if (spellProgression[1] > 0) { spellProgression[1] += 1; }
          }
          break;
        default:
          spellProgression = [0, 0, 0, 0, 0, 0, 0];
      }
  
      spellProgression.forEach((spells, index) => {
        updates[`spells_${index + 1}`] = spells;
      });
      setAttrs(updates);
    });
  })

  on("clicked:character_tab", function() {
    setAttrs({
      "show_character": "on",
      "show_notes": "0",
      "show_spells": "0"
    });
  });

  on("clicked:notes_tab", function() {
    setAttrs({
      "show_character": "0",
      "show_notes": "on",
      "show_spells": "0"
    });
  });

  on("clicked:spells_tab", function() {
    setAttrs({
      "show_character": "0",
      "show_notes": "0",
      "show_spells": "on"
    });
  });
</script>

<rolltemplate class="sheet-rolltemplate-ds-turn">
  <div class="sheet-template-container">
    <div class="sheet-template-head">
      <div class="sheet-template-head-row">
        {{#title}}<div class="sheet-turn-title">{{title}}</div>{{/title}}
        {{#subtitle}}<div class="sheet-turn-subtitle">{{subtitle}}</div>{{/subtitle}}
      </div>
    </div>
    <div class="sheet-template-body">
      <div class="sheet-template-body-row">
        <span class="sheet-turn-total">Total HD Turned: {{turncount}}</span>
      </div>
      <div class="sheet-template-body-row">
        <span class="sheet-turn-check">Turn Check: {{roll}}</span>
      </div>
      <div class="sheet-template-body-row">
        <span class="sheet-turn-check">{{computed::roll}}</span>
      </div>
    </div>
  </div>
</rolltemplate>

<rolltemplate class="sheet-rolltemplate-ds-save">
  <div class="sheet-saving-throw-container">
    <div class="sheet-saving-throw-header">
      <div class="sheet-saving-throw-header-row">
        {{#title}}
        <div class="sheet-saving-throw-header-cell">{{title}}</div>
        {{/title}}
        {{^title}}
        <div class="sheet-saving-throw-header-cell">Save vs. {{savevs}}</div>
        {{/title}}
        {{#subtitle}}
        <div class="sheet-saving-throw-header-cell">{{subtitle}}</div>
        {{/subtitle}}
        {{^subtitle}}
        {{#character}}
        <div class="sheet-saving-throw-header-cell">for {{character}}</div>
        {{/character}}
        {{/subtitle}}
      </div>
    </div>
    <div class="sheet-saving-throw-content">
      <div class="sheet-saving-throw-content-row">
        <span class="sheet-check-label">Roll</span>
        <span class="sheet-check-label"></span>
        <span class="sheet-check-label">Target</span>
      </div>
      <div class="sheet-saving-throw-content-row">
        <span class="sheet-check-value">{{saveroll}}</span>
        <span class="sheet-check-value">&ge;</span>
        <span class="sheet-check-value">{{savetarget}}</span>
      </div>
      {{#rollTotal() saveroll savetarget}}
      {{#rollWasFumble() saveroll}}
      <div class="sheet-template-result sheet-template-failure">
        CRITICAL FAILURE!
        {{#fumble}}
        <br>
        <span class="sheet-template-result-description">{{fumble}}</span>
        {{/fumble}}
      </div>
      {{/rollWasFumble() saveroll}}

      {{#^rollWasFumble() saveroll}}
      <div class="sheet-template-result sheet-template-success">
        Success!
        {{#success}}
        <br>
        <span class="sheet-template-result-description">{{success}}</span>
        {{/success}}
      </div>
      {{/^rollWasFumble() saveroll}}
      {{/rollTotal() saveroll savetarget}}

      {{#rollGreater() saveroll savetarget}}
      {{#rollWasFumble() saveroll}}
      <div class="sheet-template-result sheet-template-failure">
        CRITICAL FAILURE!
        {{#fumble}}
        <br>
        <span class="sheet-template-result-description">{{fumble}}</span>
        {{/fumble}}
      </div>
      {{/rollWasFumble() saveroll}}

      {{#^rollWasFumble() saveroll}}
      <div class="sheet-template-result sheet-template-success">
        Success!
        {{#success}}
        <br>
        <span class="sheet-template-result-description">{{success}}</span>
        {{/success}}
      </div>
      {{/^rollWasFumble() saveroll}}
      {{/rollGreater() saveroll savetarget}}

      {{#rollLess() saveroll savetarget}}
      {{#rollWasFumble() saveroll}}
      <div class="sheet-template-result sheet-template-failure">
        CRITICAL FAILURE!
        {{#fail}}
        <br>
        <span class="sheet-template-result-description">{{fail}}</span>
        {{/fail}}
      </div>
      {{/rollWasFumble() saveroll}}

      {{#^rollWasFumble() saveroll}}
      <div class="sheet-template-result sheet-template-failure">
        Failed!
        {{#fail}}
        <br>
        <span class="sheet-template-result-description">{{fail}}</span>
        {{/fail}}
      </div>
      {{/^rollWasFumble() saveroll}}
      {{/rollLess() saveroll savetarget}}
    </div>
  </div>
</rolltemplate>

<!-- Roll Templates -->
<rolltemplate class="sheet-rolltemplate-ds-attack">
  <div class="sheet-template-container">
    <div class="sheet-template-head {{color}}">
      <div class="sheet-template-head-row">
        <div class="sheet-template-head-cell">{{title}}</div>
        {{#subtitle}}
        <div class="sheet-template-head-cell">{{subtitle}}</div>
        {{/subtitle}}
      </div>
    </div>
    <div class="sheet-template-body">
      <div class="sheet-template-body-row">
        <span class="sheet-template-body-label"><b>Damage</b></span>
        <span class="sheet-template-body-label"><b>AC Hit</b></span>
      </div>
      <div class="sheet-template-body-row">
        <span class="sheet-template-attack-image sheet-template-attack-dmg">
          {{#^rollWasCrit() ac_hit}}
          {{damage}}
          {{/^rollWasCrit() ac_hit}}
          {{#rollWasCrit() ac_hit}}
          {{#crit_dmg}}{{crit_dmg}}{{/crit_dmg}}
          {{^crit_dmg}}{{damage}}{{/crit_dmg}}
          {{/rollWasCrit() ac_hit}}
        </span>
        <span class="sheet-template-attack-image sheet-template-attack-ac">{{ac_hit}}</span>
      </div>
      {{#rollWasCrit() ac_hit}}
      <div class="sheet-template-result sheet-template-success">
        CRITICAL HIT!
        {{#crit}}
        <br>
        <span class="sheet-template-result-description">{{crit}}</span>
        {{/crit}}
      </div>
      {{/rollWasCrit() ac_hit}}

      {{#rollWasFumble() ac_hit}}
      <div class="sheet-template-result sheet-template-failure">
        FUMBLE!
        {{#fumble}}
        <br>
        <span class="sheet-template-result-description">{{fumble}}</span>
        {{/fumble}}
      </div>
      {{/rollWasFumble() ac_hit}}
    </div>
  </div>
</rolltemplate>

<div id="notes" class="ds-tab-content">
  <textarea class="ds-notes-input" placeholder="Enter your notes here..."></textarea>
</div>

<div id="spells" class="ds-tab-content">
  <div class="ds-spellbook-placeholder">Spellbook content goes here...</div>
</div>